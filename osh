#!/bin/bash
#
# > osh <
#
# Helpers for the OpenStack API. Because who can remember all those flags?
# james@da.ydrea.ms

vrs='v0.1'
lastchange='2/6/15'

echo -e "\n--> osh $vrs $lastchange <--"

OLD_PS3=$PS3


### MAKE SURE WE'RE AUTHENTICATED WITH NOVA
### END MAKE SURE WE'RE AUTHENTICATED WITH NOVA



### BOOT AN INSTANCE ###

# fetch and parse available images
nova image-list > imagelist.txt

icount=0

# the image ID is a 36-character string with dashes at indices 8, 13, 18 and 23
for id in $(sed -nE 's/.*([a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{12}).*/\1/p' < imagelist.txt); do
  imageids[$icount]="$id"
  imagestrings[$icount]=$(sed -nE "/$id/ s/.*$id \| ([a-zA-Z0-9\.\-]+) +\|.*$/\1/p" < imagelist.txt)
  icount=$(($icount+1))
done
unset icount

rm -P imagelist.txt

# fetch and parse available flavors
nova flavor-list > flavorlist.txt

fcount=0

# the flavor ID is a 3-digit integer
for id in $(sed -nE 's/\| ([0-9]{3}) \|.*/\1/p' < flavorlist.txt); do
  flavorids[$fcount]="$id"
  flavornames[$fcount]=$(sed -nE "/$id/ s/.*$id \| ([a-z]+) +\|.*$/\1/p" < flavorlist.txt)
  fcount=$(($fcount+1))
done
unset fcount

rm -P flavorlist.txt

# boot function helpers
function get_key () {
  while [ -z "$keyname" ]; do
    echo -e ""
    read -p "--> Which key should this volume use? " keyname
  done
}

function make_block_device () {
  echo -e "\n--> Create the block device from a/an ..."
  PS3=$'\n'"--> Device source: "
  select devicesource in "Volume" "Snapshot" "Image" "Blank"; do
    case $devicesource in
      Volume ) devicesource="volume"; break;;
      Snapshot ) devicesource="snapshot"; break;;
      Image ) devicesource="image"; break;;
      Blank ) devicesource="blank"; break;;
    esac
  done

  if [ $devicesource == "image" ]; then
    icount=0
    ilength=${#imagestrings[*]}
    echo -e "\n--> Choose from your available images:"

    while [ $icount -lt $ilength ]; do
      echo -e "$(echo $(($icount+1)))) ${imagestrings[$icount]}"
      icount=$(($icount+1))
    done

    echo -e ""
    read -p "--> Device image: " imagechoice

    while [[ ! "$imagechoice" =~ ^[1-9]+$ || "$imagechoice" -gt $ilength ]]; do
      read -p "--> Enter an integer representing one of the $ilength choices above: " imagechoice
    done

    sourceid=${imageids[$(($imagechoice-1))]}
    imagestring=${imagestrings[$(($imagechoice-1))]}
    unset icount
  fi
}

function set_flavor () {
  fcount=0
  flength=${#flavornames[*]}
  echo -e "\n--> Choose from your available flavors:"

  while [ $fcount -lt $flength ]; do
    echo -e "$(echo $(($fcount+1)))) ${flavornames[$fcount]}"
    fcount=$(($fcount+1))
  done

  echo -e ""
  read -p "--> Device flavor: " flavorchoice

  while [[ ! "$flavorchoice" =~ ^[1-9]+$ || "$flavorchoice" -gt $flength ]]; do
    read -p "--> Enter an integer representing one of the $flength choices above: " flavorchoice
  done

  flavorid=${flavorids[$(($flavorchoice-1))]}
  flavorname=${flavornames[$(($flavorchoice-1))]}
  unset fcount
}

function get_devicetype () {
  echo -e "\n--> Which type of device will it be?"
  PS3=$'\n'"--> Device type: "
  select devicetype in "Volume" "Local"; do
    case $devicetype in
      Volume ) devicetype="volume"; break;;
      Local ) devicetype="local"; break;;
    esac
  done
}

function set_storagesize () {
  echo -e ""
  read -p "--> How many gigabytes of storage? Default is 80: " storagesize
  if [ -z "$storagesize" ]; then
    storagesize="80"
  fi
  while [[ ! "$storagesize" =~ ^[0-9]+$ ]]; do
    read -p "--> The storage size should be an integer. Default is 80 gigabytes: " storagesize
  done
}

function set_bootindex () {
  while [ -z "$bootindex" ]; do
    echo -e ""
    read -p "--> Boot index? (Enter 0 to boot from this volume.): " bootindex
  done
  while [[ ! "$bootindex" =~ ^[0-9]+$ ]]; do
    read -p "--> The boot index should be an integer. (Enter 0 to boot from this volume.): " bootindex
  done
}

function set_preserve () {
  echo -e "\n--> Preserve the volume when the instance is shut down?"
  PS3=$'\n'"--> Preserve on shutdown? "
  select preserve in "Yes" "No"; do
    case $preserve in
      Yes ) preserve="preserve"; break;;
      No ) preserve="remove"; break;;
    esac
  done
}

function set_servername () {
  while [ -z "$servername" ]; do
    echo -e ""
    read -p "--> What will you name this server? " servername
  done
}



# boot functions
function boot_ephemeral () {
  get_key
  set_flavor
  make_block_device
  set_servername
  nova boot --poll --flavor "$flavorname" --image "$imagestring" --key-name "$keyname" "$servername"
}

function boot_persistent () {
  get_key
  set_flavor
  make_block_device
  set_storagesize
  set_preserve
  set_bootindex
  set_servername
  nova boot --poll --flavor "$flavorname" --key-name "$keyname" --block-device source="$devicesource",id="$sourceid",dest="$devicetype",size="$storagesize",shutdown="$preserve",bootindex="$bootindex" "$servername"
}


if [ "$1" == "boot" ]; then
  # collect persistence type
  if [ "$2" == "ephemeral" ]; then
    boottype="ephemeral"
  elif [ "$2" == "persistent" ]; then
    boottype="persistent"
  else
    echo -e "\n--> Will this be an ephemeral or a persistent instance? "
    PS3=$'\n'"--> Instance type: "
    select boottype in "Ephemeral" "Persistent"; do
      case $boottype in
        Ephemeral ) boottype="ephemeral"; break;;
        Persistent ) boottype="persistent"; break;;
      esac
    done
  fi # end collecting persistence type

  if [ "$boottype" == "ephemeral" ]; then
    boot_ephemeral
  fi

  if [ "$boottype" == "persistent" ]; then
    boot_persistent
  fi
fi # end main

### END BOOT AN INSTANCE ###

PS3=$OLD_PS3
